# Comments used for documentation, ALWAYS KEEP THEM UP TO DATE (that or remove them)

# yaml fragment for auth using env var securely stored in CircleCI, needed to pull our GCloud hosted images
gcloud_auth: &gcloud_auth 
  auth:
    username: _json_key
    password: $GCLOUD_JSON_AUTH


version: 2
jobs:

  # Build job steps:
  #  1) Checkout project from repo
  #  2) Node module sub-steps:
  #    2.1) restore cached node modules if a cache matches the current package-lock.json
  #    2.2) if no cache restored then node_modules dir not present, in which case we run an npm ci
  #    2.3) cache the current node modules by the package-lock.json
  #  3) Build sub-steps:
  #    3.1) check cached builds by branch and revision number, restore if it exists
  #    3.2) for the build, run only if a certain file (app-a11y bundle) is missing
  #    3.3) cache the build by branch and revision number
  #  4) Persist everything (project, node_modules, and build) to the workspace, to be available in other jobs in the work flow run
  # Note: the image used for this job is built from a docker file found in ../dockerfiles/build
  build:
    docker:
      - image: gcr.io/ib-static-content/ib-client-ci-build:latest
        <<: *gcloud_auth
    working_directory: "~/InfoBase/client"
    steps:
      - checkout:
          path: "~/InfoBase"
      - run: pwd
      - run: chmod +x ./ci_scripts/chmod_scripts.sh
      - run: ./ci_scripts/chmod_scripts.sh
      - run: ./ci_scripts/create_envs.sh
      - restore_cache:
          keys:
            - ib-client-dependencies-{{ checksum "package-lock.json" }}
      - run: 
          command: |
            [ -e "node_modules" ] || npm ci
      
      - save_cache:
          paths:
            - node_modules
          key: ib-client-dependencies-{{ checksum "package-lock.json" }}
      - restore_cache:
          keys:
            - ib-prod-build-{{ .Branch }}-{{ .Revision }}
      - run:
          command: |
            [ -f "build/InfoBase/app/app-a11y-en.min.js" ] || ./deploy_build_scripts/build_all.sh

      - save_cache:
          paths:
            - build
          key: ib-prod-build-{{ .Branch }}-{{ .Revision }}
      - persist_to_workspace:
          root: ./
          paths:
            - ./build
            - ./node_modules
            - ./browser-tests
            - ./ci_scripts
            - ./deploy_build_scripts
            - ./package.json

  
  # Test job steps:
  #  1) mount workspace (meaning this job must be run in a workflow where it is proceeded by a build job)
  #  2) run the ci_serve command from package.json (start a localhost server on the container)
  #  3) run the ci_route_load_tests command from package.json (use testcafe and headless chromium to visit the build on the container)
  # Note: the image used for this job is built from a docker file found in ../dockerfiles/test
  test:
    docker:
      - image: gcr.io/ib-static-content/ib-client-ci-test:latest
        <<: *gcloud_auth
    working_directory: "~/InfoBase/client"
    steps:
      - attach_workspace:
          at: ./client
      - run: sh ./ci_scripts/create_envs.sh
      - run: sed -i "s#${CDN_URL}#.#g" ./build/InfoBase/app/*.js # Replace the CDN_URL instances in the built InfoBase so the tests will get the right files (ie. NOT just test the previous deploy)
      - run: sed -i "s#${CDN_URL}#.#g" ./build/InfoBase/*.html # Replace the CDN_URL instances in the built InfoBase so the tests will get the right files (ie. NOT just test the previous deploy)
      - run: 
          name: start_server
          command: npm run ci_serve
          background: true
      - run: npm run ci_route_load_tests


  # Deploy job steps:
  #  1) mount workspace (meaning this job must be run in a workflow where it is proceeded by a build job)
  #  2) make ./ci_scripts/authenticate-gcloud.sh executable
  #  3) execute ./ci_scripts/authenticate-gcloud.sh (authenticate with google cloud using env variable securely stored with CircleCI)
  #  4) rsync the built IB to the InfoBase static bucket
  # Note: the image used for this job is provided by google
  deploy:
    working_directory: "~/InfoBase/client"
    docker:
      - image: google/cloud-sdk:slim
    steps:
      - attach_workspace:
          at: ./client
      - run: ./ci_scripts/create_envs.sh
      - run: ./ci_scripts/authenticate-gcloud.sh
      - run: ./deploy_build_scripts/push_to_gcloud_bucket.sh
      

# One workflow that runs all three jobs (build -> test -> deploy), each requiring the previous to have passed
# Note that deploy is filtered by branch to only run on master
workflows:
  version: 2
  build_test_deploy:
    jobs:
      - build
      - test:
          requires:
            - build
      - deploy:
          requires:
            - test
          filters:
            branches:
              only:
                - master
